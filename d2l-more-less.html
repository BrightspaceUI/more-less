<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-icons/tier1-icons.html">
<link rel="import" href="../d2l-image-action/d2l-image-action.html">

<dom-module id="d2l-more-less">
	<template>
		<style>
			.more-less-content {
				overflow: hidden;
				transition: height 400ms cubic-bezier(0, 0.7, 0.5, 1);
			}

			.more-less-blur {
				display: block;
				content: "";
				position: relative;
				height: 1em;
				bottom: 1em;

				background: linear-gradient(rgba(250, 250, 250, 0) 0%, rgb(250, 250, 250) 100%);

				opacity: 1;
				transition: opacity 400ms cubic-bezier(0, 0.7, 0.5, 1);
			}
			:host[expanded] .more-less-blur {
				opacity: 0;
			}

			.more-less-less {
				display: none;
			}
			:host[expanded] .more-less-less {
				display: inline-block;
			}

			:host[expanded] .more-less-more {
				display: none;
			}

			:host[inert] .more-less-blur,
			:host[inert] .more-less-more,
			:host[inert] .more-less-less {
				display: none;
			}
		</style>

		<div class="more-less-content">
			<slot></slot>
		</div>
		<div class="more-less-blur"></div>
		<button
   			class="more-less-more"
			is="d2l-image-action"
			icon="d2l-tier1:arrow-toggle-down"
			aria-hidden="true"
			>more</button>
		<button
   			class="more-less-less"
			is="d2l-image-action"
			icon="d2l-tier1:arrow-toggle-up"
			aria-hidden="true"
			>less</button>
	</template>
</dom-module>
<script>
	Polymer({
		is: 'd2l-more-less',
		properties: {
			height: {
				type: String,
				value: '4em',
				notify: true,
				reflectToAttribute: true
			},
			expanded: {
				type: Boolean,
				value: false,
				reflectToAttribute: true
			},
			inert: {
				type: Boolean,
				value: false,
				reflectToAttribute: true
			}
		},

		__baseHeight: 0,
		__observer: null,
		__content: null,
		__more: null,
		__less: null,

		attached: function moreLessAttached() {
			this.__content = this.$$('.more-less-content');
			this.__more = this.$$('.more-less-more');
			this.__less = this.$$('.more-less-less');

			this.__content.style.height = this.height;

			Polymer.RenderStatus.afterNextRender(this, function moreLessAttachedNextRender() {
				if (!this.isAttached) {
					return;
				}

				this.__baseHeight = this.__content.offsetHeight;
				this.__reactToChanges();
				this.__startObserving();

				this.listen(this.__more, 'click', '__moreOnClick');
				this.listen(this.__less, 'click', '__lessOnClick');
			});
		},
		detached: function moreLessDetached() {
			if (this.__observer) {
				this.__observer.disconnect();
				this.__observer = null;
			}
		},
		__moreOnClick: function moreLessMoreOnClick() {
			this.__content.style.height = this.__content.scrollHeight + 'px';
			this.expanded = true;
			this.__less.focus();
		},
		__lessOnClick: function moreLessLessOnClick() {
			this.__content.style.height = this.height;
			this.expanded = false;
			this.__more.focus();
		},
		__reactToChanges: function moreLessReactToChanges() {
			var contentHeight = this.__content.scrollHeight;
			if (contentHeight === this.__baseHeight) {
				if (!this.inert) {
					this.inert = true;
					this.expanded = false;
				}
				return;
			}

			if (this.inert) {
				this.inert = false;
				return;
			}

			if (this.expanded) {
				this.__content.style.height = contentHeight + 'px';
			}
		},
		__startObserving: function moreLessStartObserving() {
			this.__observer = this.__observer || new MutationObserver(this.__reactToChanges.bind(this));
			this.__observer.observe(this.__content, {
				childList: true,
				subtree: true,
				characterData: true,
				attributes: true
			});
		}
	});
</script>
